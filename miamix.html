<!DOCTYPE html>
<html>
<head>
  <title>Live Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #009500;
      --primary-dark: #007700;
      --confirmed: #4CAF50;
      --delivered: #9E9E9E;
      --ordered: #FF9800;
      --bg-color: #f5f7fa;
      --card-bg: #ffffff;
      --text-dark: #333333;
      --text-light: #666666;
      --border-radius: 12px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-dark);
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    h1 {
      font-size: 28px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .download-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .download-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    #orders {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 80px;
    }
    
    .order {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--box-shadow);
      transition: all 0.3s ease;
      border-left: 5px solid var(--ordered);
    }
    
    .order:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .order.confirmed {
      border-left-color: var(--confirmed);
    }
    
    .order.delivered {
      border-left-color: var(--delivered);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px dashed #e0e0e0;
    }
    
    .order-meta {
      color: var(--text-light);
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .order-number {
      font-weight: 600;
      color: var(--primary);
      font-size: 18px;
    }
    
    .order-table {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.table-circle {
  width: 40px;
  height: 40px;
  border: 2px solid #C58917;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #fff;
  background: #D29F51;
}

.table-label {
  font-size: 12px;
  color: #000;
}
    
    .order-items {
      margin: 15px 0;
      padding-left: 20px;
    }
    
    .order-items li {
      margin-bottom: 8px;
      position: relative;
    }
    
    .order-items li:before {
      content: "•";
      color: var(--primary);
      font-weight: bold;
      position: absolute;
      left: -15px;
    }
    
    .order-total {
      font-weight: 600;
      font-size: 18px;
      margin: 15px 0;
      text-align: right;
    }
    
    .order-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
    }
    
    .ordered .order-status {
      background-color: rgba(255, 152, 0, 0.1);
      color: var(--ordered);
    }
    
    .confirmed .order-status {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--confirmed);
    }
    
    .delivered .order-status {
      background-color: rgba(158, 158, 158, 0.1);
      color: var(--delivered);
    }
    
    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .action-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .confirm-btn {
      background-color: var(--primary);
      color: white;
    }
    
    .confirm-btn:hover {
      background-color: var(--primary-dark);
    }
    
    .deliver-btn {
      background-color: #616161;
      color: white;
    }
    
    .deliver-btn:hover {
      background-color: #424242;
    }
    
    #enable-sound {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: var(--border-radius);
      cursor: pointer;
      box-shadow: var(--box-shadow);
      z-index: 999;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #enable-sound:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 50px 20px;
      color: var(--text-light);
    }
    
    .empty-state i {
      font-size: 50px;
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    @media (max-width: 768px) {
      #orders {
        grid-template-columns: 1fr;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-concierge-bell"></i> Incoming Orders</h1>
      <button class="download-btn" onclick="downloadStoredOrders()">
        <i class="fas fa-download"></i> Download Orders
      </button>
    </header>
    
    <div id="orders">
      <!-- Orders will be rendered here -->
      <div class="empty-state">
        <i class="fas fa-utensils"></i>
        <h3>No orders yet</h3>
        <p>New orders will appear here automatically</p>
      </div>
    </div>
  </div>
  
  <button id="enable-sound">
    <i class="fas fa-bell"></i> Enable Sound Notifications
  </button>
  
  <audio id="notif-sound" src="https://cdn.shopify.com/s/files/1/0947/2340/8240/files/water_drop_tone.mp3?v=1747184325" preload="auto"></audio>  

  <script>
    const orders = {};

    // Load saved orders on page load
    window.addEventListener("DOMContentLoaded", () => {
      const stored = localStorage.getItem("storedOrders");
      if (stored) {
        const parsed = JSON.parse(stored);
        Object.assign(orders, parsed);
        renderOrders();
      }
    });

    // Save orders to localStorage
    function saveOrdersToStorage() {
      localStorage.setItem("storedOrders", JSON.stringify(orders));
    }

    async function handleOrder(order) {
      orders[order.orderNumber] = order;
      saveOrdersToStorage();
      renderOrders();
      
      // Play sound if enabled
      if (soundEnabled) {
        document.getElementById("notif-sound").play();
      }
    }

    function renderOrders() {
      const container = document.getElementById("orders");
      
      if (Object.keys(orders).length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-utensils"></i>
            <h3>No orders yet</h3>
            <p>New orders will appear here automatically</p>
          </div>
        `;
        return;
      }

      container.innerHTML = "";

      const sortedOrders = Object.values(orders).sort((a, b) => {
        const statusPriority = { "Ordered": 0, "Confirmed": 1, "Delivered": 2 };
        const statusCompare = statusPriority[a.status] - statusPriority[b.status];
        if (statusCompare !== 0) return statusCompare;
        return b.orderNumber - a.orderNumber;
      });

      sortedOrders.forEach(order => {
        const div = document.createElement("div");
        div.className = `order ${order.status.toLowerCase()}`;
      div.innerHTML = `
  <div class="order-header">
    <div>
      <div class="order-meta">${order.date || 'N/A'} • ${order.time || 'N/A'}</div>
      <div class="order-number">Order #${order.orderNumber}</div>
    </div>
    <div class="order-table">
      <div class="table-circle">${order.table}</div>
      <div class="table-label">Table</div>
    </div>
  </div>
  
  <div class="order-status">${order.status}</div>
  
  <ul class="order-items">${order.cart.map(item => `
    <li>${item.name} <span style="color: var(--text-light)">× ${item.quantity}</span> - $${item.total.toFixed(2)}</li>
  `).join("")}</ul>
  
  <div class="order-total">Total: $${order.total}</div>
  
  <div class="order-actions">
    ${order.status === 'Ordered' ? `
      <button class="action-btn confirm-btn" onclick="markStatus('${order.orderNumber}', 'Confirmed')">
        <i class="fas fa-check"></i> Confirm
      </button>
    ` : ''}
    
    ${order.status !== 'Delivered' ? `
      <button class="action-btn deliver-btn" onclick="markStatus('${order.orderNumber}', 'Delivered')">
        <i class="fas fa-truck"></i> Deliver
      </button>
    ` : ''}
  </div>
`;
        container.appendChild(div);
      });
    }

    async function markStatus(orderNumber, status) {
      const res = await fetch("https://citrine-flint-sea.glitch.me/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderNumber, status })
      });

      if (res.ok && orders[orderNumber]) {
        orders[orderNumber].status = status;
        saveOrdersToStorage();
        renderOrders();
      }
    }

    // Handle postMessage order receiving
    window.addEventListener("message", async (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.orderNumber) handleOrder(data);
      } catch (e) {}
    });

    let lastOrderCount = 0;
    let soundEnabled = false;

    async function fetchOrders() {
      const res = await fetch("https://citrine-flint-sea.glitch.me/orders");
      const orderList = await res.json();

      if (soundEnabled && orderList.length > lastOrderCount) {
        document.getElementById("notif-sound").play();
      }

      lastOrderCount = orderList.length;

      orderList.forEach(order => {
        if (!orders[order.orderNumber]) {
          orders[order.orderNumber] = order;
        }
      });

      saveOrdersToStorage();
      renderOrders();
    }

    setInterval(fetchOrders, 60000);
    fetchOrders();

    document.getElementById("enable-sound").addEventListener("click", () => {
      const audio = document.getElementById("notif-sound");
      audio.play().then(() => {
        soundEnabled = true;
        document.getElementById("enable-sound").style.display = "none";
        localStorage.setItem("soundEnabled", "true");
      }).catch((e) => {
        console.error("Audio failed to play:", e);
      });
    });

    // Check if sound was previously enabled
    if (localStorage.getItem("soundEnabled") === "true") {
      soundEnabled = true;
      document.getElementById("enable-sound").style.display = "none";
    }

    // Download as HTML
    function downloadStoredOrders() {
      const stored = localStorage.getItem("storedOrders");
      if (!stored) return alert("No orders to download.");

      const ordersData = JSON.parse(stored);
      const htmlContent = `
        <html>
        <head>
          <title>Stored Orders</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #009500; }
            .order { border-bottom: 1px solid #eee; padding: 15px 0; }
            .order-meta { color: #666; font-size: 14px; }
            .order-number { font-weight: bold; color: #009500; }
            .order-table { background: #009500; color: white; padding: 2px 8px; border-radius: 10px; display: inline-block; font-size: 12px; }
            .order-items { margin: 10px 0; padding-left: 20px; }
            .order-total { font-weight: bold; text-align: right; }
            .order-status { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 12px; background: #f0f0f0; }
            .status-ordered { background: #fff3e0; color: #ff9800; }
            .status-confirmed { background: #e8f5e9; color: #4caf50; }
            .status-delivered { background: #f5f5f5; color: #9e9e9e; }
          </style>
        </head>
        <body>
          <h1>Order History</h1>
          ${Object.values(ordersData).map(order => `
            <div class="order">
              <div class="order-meta">${order.date || 'N/A'} • ${order.time || 'N/A'}</div>
              <div>
                <span class="order-number">Order #${order.orderNumber}</span>
                <span class="order-table">Table ${order.table}</span>
              </div>
              <div class="order-status status-${order.status.toLowerCase()}">${order.status}</div>
              <ul class="order-items">${order.cart.map(item => `
                <li>${item.name} × ${item.quantity} - $${item.total.toFixed(2)}</li>
              `).join('')}</ul>
              <div class="order-total">Total: $${order.total}</div>
            </div>
          `).join('')}
        </body>
        </html>
      `;

      const blob = new Blob([htmlContent], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "stored-orders.html";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Expose to global scope
    window.downloadStoredOrders = downloadStoredOrders;
  </script>
</body>
</html>
